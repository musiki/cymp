<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Consola Atómica - El Juego</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            font-family: 'Press Start 2P', cursive;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #game-container {
            border: 4px solid #333;
            box-shadow: 0 0 20px #00ff41, inset 0 0 15px #333;
            background-color: #111;
            padding: 10px;
        }
        canvas {
            background-color: #000;
            display: block;
            border: 2px solid #555;
        }
        #ui-container {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background-color: #222;
            border: 2px solid #555;
            margin-top: 10px;
        }
        .ui-panel {
            width: 30%;
        }
        .ui-label {
            color: #00ff41;
            font-size: 12px;
        }
        .ui-value {
            color: #fff;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 15px;
            background-color: #444;
            border: 1px solid #888;
            margin-top: 5px;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #00ff41;
            transition: width 0.1s linear;
        }
        #message-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0,0,0,0.8);
            padding: 40px;
            border: 4px solid #fff;
            text-align: center;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div id="ui-container">
            <div class="ui-panel">
                <div class="ui-label">POTENCIA</div>
                <div class="ui-value" id="power-value">0 MW</div>
                <div class="progress-bar"><div id="power-bar" class="progress-bar-inner"></div></div>
            </div>
            <div class="ui-panel">
                <div class="ui-label">TEMP. NÚCLEO</div>
                <div class="ui-value" id="temp-value">25 °C</div>
                <div class="progress-bar"><div id="temp-bar" class="progress-bar-inner"></div></div>
            </div>
            <div class="ui-panel">
                <div class="ui-label">ESTABILIDAD</div>
                <div class="ui-value" id="stability-value">ESTABLE</div>
                <div class="progress-bar"><div id="integrity-bar" class="progress-bar-inner" style="background-color: #42a5f5;"></div></div>
            </div>
        </div>
    </div>
    
    <div id="message-overlay">
        <h2 id="message-title">TÍTULO</h2>
        <p id="message-text">Texto del mensaje.</p>
        <p id="message-prompt" style="margin-top: 20px; color: #ffff00;">Presiona Enter para continuar</p>
    </div>

    <script>
    //================================================================================
    // LA CONSOLA ATÓMICA - EL JUEGO ARCADE
    //================================================================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // --- MÓDULO 1: GESTOR DE ESTADO DEL JUEGO ---
    const GameState = {
        gameStatus: 'idle', // 'idle', 'running', 'scram', 'meltdown', 'stall', 'paused'
        currentLevel: 'MACRO', // 'MACRO', 'MICRO'
        lastUpdate: 0,
        
        // Parámetros Físicos del Reactor
        PROMPT_LIFETIME: 0.00002,
        BETA_TOTAL: 0.0065,
        BETA_GROUPS: [0.00021, 0.00142, 0.00127, 0.00257, 0.00075, 0.00027],
        LAMBDA_GROUPS: [0.0124, 0.0305, 0.111, 0.301, 1.14, 3.01],
        FUEL_TEMP_COEFF: -0.00002,
        COOLANT_TEMP_COEFF: 0.00005,
        
        // Variables de estado del reactor
        power: 0,
        normalizedPower: 0,
        neutronPopulation: 1,
        precursorConcentrations: [0, 0, 0, 0, 0, 0],
        reactivity: -0.05,
        fuelTemp: 25,
        coolantTemp: 25,
        controlRodPosition: 100,
        
        // Parámetros de juego
        reactorIntegrity: 100,
        demand: 0.1,
        score: 0,

        // Estado del Nivel Macro
        player: { x: 100, y: 520, width: 24, height: 48, vx: 0, frame: 0 },
        
        // Estado del Nivel Micro
        microPlayer: { x: 400, y: 550, angle: -Math.PI/2, vx: 0, vy: 0, thrusting: false },
        microParticles: [],
        microFissions: 0,
    };

    for (let i = 0; i < 6; i++) {
        GameState.precursorConcentrations[i] = (GameState.BETA_GROUPS[i] / GameState.LAMBDA_GROUPS[i]) * GameState.neutronPopulation / GameState.PROMPT_LIFETIME;
    }

    // --- MÓDULO 2: MOTOR DE FÍSICA ---
    // (Reutilizado de la versión anterior, sin cambios en la lógica)
    const PhysicsEngine = {
        update(dt) {
            if (GameState.gameStatus !== 'running') return;
            const rodReactivity = (GameState.controlRodPosition / 100 - 1) * 0.05;
            const fuelTempReactivity = (GameState.fuelTemp - 25) * GameState.FUEL_TEMP_COEFF;
            let coolantTempReactivity = (GameState.coolantTemp > 300) ? (GameState.coolantTemp - 300) * GameState.COOLANT_TEMP_COEFF : 0;
            GameState.reactivity = rodReactivity + fuelTempReactivity + coolantTempReactivity;
            let dNeutrons_dt = ((GameState.reactivity - GameState.BETA_TOTAL) / GameState.PROMPT_LIFETIME) * GameState.neutronPopulation;
            const dPrecursors_dt = [0, 0, 0, 0, 0, 0];
            for (let i = 0; i < 6; i++) {
                dNeutrons_dt += GameState.LAMBDA_GROUPS[i] * GameState.precursorConcentrations[i];
                dPrecursors_dt[i] = (GameState.BETA_GROUPS[i] / GameState.PROMPT_LIFETIME) * GameState.neutronPopulation - GameState.LAMBDA_GROUPS[i] * GameState.precursorConcentrations[i];
            }
            GameState.neutronPopulation += dNeutrons_dt * dt;
            for (let i = 0; i < 6; i++) {
                GameState.precursorConcentrations[i] += dPrecursors_dt[i] * dt;
            }
            GameState.normalizedPower = GameState.neutronPopulation / 1e7;
            GameState.power = GameState.normalizedPower * 950;
            GameState.fuelTemp += (GameState.normalizedPower * 200 - (GameState.fuelTemp - GameState.coolantTemp) * 0.5) * dt;
            GameState.coolantTemp += ((GameState.fuelTemp - GameState.coolantTemp) * 0.4 - GameState.coolantTemp * 0.1) * dt;
            GameState.fuelTemp = Math.max(25, GameState.fuelTemp);
            GameState.coolantTemp = Math.max(25, GameState.coolantTemp);
            GameState.demand += (Math.random() - 0.5) * 0.05 * dt;
            GameState.demand = Math.max(0.1, Math.min(1, GameState.demand));
            const error = Math.abs(GameState.normalizedPower - GameState.demand);
            if (error < 0.05) GameState.score += (1 - error / 0.05) * dt * 10;
            this.checkFailures();
        },
        checkFailures() {
            if (GameState.fuelTemp > 2800 || GameState.reactorIntegrity <= 0) {
                GameManager.endGame('meltdown');
            }
            const reactivityInDollars = GameState.reactivity / GameState.BETA_TOTAL;
            if (reactivityInDollars >= 1.0 || GameState.coolantTemp > 350) {
                this.triggerScram();
            }
            if (GameState.power < 1 && GameState.neutronPopulation < 10) {
                 GameManager.endGame('stall');
            }
        },
        triggerScram() {
            if (GameState.gameStatus === 'running') {
                GameState.gameStatus = 'scram';
                GameState.controlRodPosition = 0;
                GameState.reactorIntegrity = Math.max(0, GameState.reactorIntegrity - 25);
                AudioEngine.triggerScram();
                GameManager.showMessage('¡¡¡SCRAM!!!', 'APAGADO DE EMERGENCIA', 5000, () => {
                    if (GameState.gameStatus === 'scram') GameState.gameStatus = 'running';
                });
            }
        }
    };

    // --- MÓDULO 3: MOTOR DE RENDERIZADO ---
    const Renderer = {
        drawMacroLevel() {
            ctx.fillStyle = '#2c3e50';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Fondo
            ctx.fillStyle = '#34495e';
            ctx.fillRect(0, 568, canvas.width, 32); // Suelo
            ctx.fillRect(0, 0, canvas.width, 450); // Pared
            
            // Consolas
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(50, 450, 150, 118);
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(55, 455, 140, 110);
            ctx.fillStyle = '#000';
            ctx.fillRect(65, 465, 120, 80);
            
            ctx.fillStyle = '#7f8c8d';
            ctx.fillRect(600, 450, 150, 118);
            ctx.fillStyle = '#95a5a6';
            ctx.fillRect(605, 455, 140, 110);
            ctx.fillStyle = '#000';
            ctx.fillRect(615, 465, 120, 80);

            // Dibujar jugador
            ctx.fillStyle = '#ecf0f1';
            ctx.fillRect(GameState.player.x, GameState.player.y, GameState.player.width, GameState.player.height);
            ctx.fillStyle = '#3498db'; // Cabeza
            ctx.fillRect(GameState.player.x, GameState.player.y, GameState.player.width, 16);

            // Texto de interacción
            ctx.fillStyle = '#ffff00';
            ctx.font = '12px "Press Start 2P"';
            if (GameState.player.x > 20 && GameState.player.x < 200) {
                ctx.fillText("[E] Barras Control", 60, 440);
            }
            if (GameState.player.x > 550 && GameState.player.x < 750) {
                ctx.fillText("[E] Ver Núcleo", 620, 440);
            }
        },
        drawMicroLevel() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Núcleo central (pozo gravitacional)
            const nucleusX = canvas.width / 2;
            const nucleusY = canvas.height / 2;
            const gradient = ctx.createRadialGradient(nucleusX, nucleusY, 10, nucleusX, nucleusY, 100);
            gradient.addColorStop(0, '#ffcc00');
            gradient.addColorStop(1, 'rgba(50,50,0,0)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(nucleusX-5, nucleusY-5, 10, 10);

            // Dibujar partículas
            GameState.microParticles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
            });

            // Dibujar jugador (nave/neutrón)
            ctx.save();
            ctx.translate(GameState.microPlayer.x, GameState.microPlayer.y);
            ctx.rotate(GameState.microPlayer.angle);
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.moveTo(10, 0);
            ctx.lineTo(-5, -7);
            ctx.lineTo(-5, 7);
            ctx.closePath();
            ctx.fill();

            if (GameState.microPlayer.thrusting) {
                ctx.fillStyle = '#ff5722';
                ctx.beginPath();
                ctx.moveTo(-5, -5);
                ctx.lineTo(-15, 0);
                ctx.lineTo(-5, 5);
                ctx.closePath();
                ctx.fill();
            }
            ctx.restore();
        },
        updateUI() {
            document.getElementById('power-value').textContent = `${GameState.power.toFixed(0)} MW`;
            document.getElementById('power-bar').style.width = `${Math.min(100, GameState.normalizedPower * 100)}%`;
            
            document.getElementById('temp-value').textContent = `${GameState.fuelTemp.toFixed(0)} °C`;
            const tempPercent = Math.min(100, (GameState.fuelTemp / 2800) * 100);
            const tempBar = document.getElementById('temp-bar');
            tempBar.style.width = `${tempPercent}%`;
            tempBar.style.backgroundColor = tempPercent > 80 ? '#f44336' : tempPercent > 60 ? '#ffeb3b' : '#00ff41';
            
            const error = Math.abs(GameState.normalizedPower - GameState.demand);
            const stabilityLabel = document.getElementById('stability-value');
            if (error < 0.05) stabilityLabel.textContent = 'ESTABLE';
            else if (error < 0.15) stabilityLabel.textContent = 'FLUCTUANDO';
            else stabilityLabel.textContent = 'INESTABLE';
            
            document.getElementById('integrity-bar').style.width = `${GameState.reactorIntegrity}%`;
        }
    };

    // --- MÓDULO 4: MOTOR DE AUDIO ---
    const AudioEngine = {
        audioCtx: null, masterGain: null, sources: {},
        init() {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.audioCtx.createGain();
            this.masterGain.connect(this.audioCtx.destination);
            const drone = this.audioCtx.createOscillator();
            drone.type = 'sawtooth'; drone.frequency.value = 50;
            const droneGain = this.audioCtx.createGain(); droneGain.gain.value = 0;
            drone.connect(droneGain).connect(this.masterGain); drone.start();
            this.sources.drone = drone; this.sources.droneGain = droneGain;
            const noise = this.createNoiseSource();
            const filter = this.audioCtx.createBiquadFilter(); filter.type = 'lowpass'; filter.frequency.value = 200;
            noise.connect(filter).connect(this.masterGain); noise.start();
            this.sources.reactivityFilter = filter;
        },
        update() {
            if (!this.audioCtx || GameState.gameStatus !== 'running') return;
            const t = this.audioCtx.currentTime;
            this.sources.drone.frequency.linearRampToValueAtTime(40 + GameState.normalizedPower * 60, t + 0.1);
            this.sources.droneGain.gain.linearRampToValueAtTime(Math.min(0.2, GameState.normalizedPower * 0.3), t + 0.1);
            const reactivityInDollars = GameState.reactivity / GameState.BETA_TOTAL;
            this.sources.reactivityFilter.frequency.linearRampToValueAtTime(200 + Math.max(0, reactivityInDollars) * 8000, t + 0.1);
        },
        createNoiseSource() {
            const bufferSize = this.audioCtx.sampleRate * 2;
            const buffer = this.audioCtx.createBuffer(1, bufferSize, this.audioCtx.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
            const source = this.audioCtx.createBufferSource();
            source.buffer = buffer; source.loop = true;
            return source;
        },
        playSfx(type) {
            if (!this.audioCtx) return;
            const t = this.audioCtx.currentTime;
            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();
            osc.connect(gain).connect(this.masterGain);
            if (type === 'fission') {
                const noise = this.createNoiseSource();
                noise.loop = false;
                gain.gain.setValueAtTime(0.5, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
                noise.connect(gain);
                noise.start(t);
                noise.stop(t + 0.3);
            } else if (type === 'thrust') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(50, t);
                osc.frequency.linearRampToValueAtTime(100, t + 0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            }
        },
        triggerScram() { this.playAlarm(800, 0.5); },
        playAlarm(freq, duration) { /* ... */ }
    };

    // --- MÓDULO 5: GESTOR DE ENTRADAS ---
    const InputHandler = {
        keys: {},
        init() {
            window.addEventListener('keydown', e => this.keys[e.code] = true);
            window.addEventListener('keyup', e => {
                if(e.code === 'KeyE') GameManager.handleInteraction();
                if(e.code === 'Enter') GameManager.handleEnter();
                delete this.keys[e.code];
            });
        }
    };

    // --- MÓDULO 6: GESTOR DEL JUEGO ---
    const GameManager = {
        init() {
            InputHandler.init();
            this.showMessage('LA CONSOLA ATÓMICA', 'Un juego de simulación nuclear', Infinity);
        },
        start() {
            GameState.gameStatus = 'running';
            GameState.lastUpdate = performance.now();
            if (AudioEngine.audioCtx.state === 'suspended') AudioEngine.audioCtx.resume();
            document.getElementById('message-overlay').style.display = 'none';
            gameLoop();
        },
        handleInteraction() {
            if (GameState.currentLevel === 'MACRO') {
                if (GameState.player.x > 20 && GameState.player.x < 200) { // Barras
                    GameState.controlRodPosition = GameState.controlRodPosition === 100 ? 50 : 100;
                }
                if (GameState.player.x > 550 && GameState.player.x < 750) { // Ver núcleo
                    this.switchLevel('MICRO');
                }
            }
        },
        handleEnter() {
            if (GameState.gameStatus === 'idle' || GameState.gameStatus === 'paused' || GameState.gameStatus === 'scram' || GameState.gameStatus === 'meltdown' || GameState.gameStatus === 'stall') {
                if(document.getElementById('message-overlay').style.display !== 'none') {
                    if (GameState.gameStatus === 'idle') this.start();
                    else location.reload();
                }
            }
        },
        switchLevel(level) {
            GameState.currentLevel = level;
            if (level === 'MICRO') {
                this.setupMicroLevel();
            }
        },
        setupMicroLevel() {
            GameState.microParticles = [];
            GameState.microFissions = 0;
            for (let i=0; i<20; i++) { // Uranio
                GameState.microParticles.push({
                    type: 'U', x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 10, color: '#00ff41'
                });
            }
            for (let i=0; i<50; i++) { // Moderador
                GameState.microParticles.push({
                    type: 'M', x: Math.random() * canvas.width, y: Math.random() * canvas.height, size: 6, color: '#3498db'
                });
            }
        },
        updateMicroLevel(dt) {
            // Player movement (Spacewar! style)
            const player = GameState.microPlayer;
            if (InputHandler.keys['ArrowLeft']) player.angle -= 5 * dt;
            if (InputHandler.keys['ArrowRight']) player.angle += 5 * dt;
            if (InputHandler.keys['ArrowUp']) {
                player.vx += Math.cos(player.angle) * 150 * dt;
                player.vy += Math.sin(player.angle) * 150 * dt;
                player.thrusting = true;
                AudioEngine.playSfx('thrust');
            } else {
                player.thrusting = false;
            }
            
            // Gravity
            const dx = canvas.width/2 - player.x;
            const dy = canvas.height/2 - player.y;
            const distSq = dx*dx + dy*dy;
            if (distSq > 1) {
                player.vx += (dx / distSq) * 500 * dt;
                player.vy += (dy / distSq) * 500 * dt;
            }

            player.x += player.vx * dt;
            player.y += player.vy * dt;

            // Screen wrap
            if(player.x < 0) player.x = canvas.width;
            if(player.x > canvas.width) player.x = 0;
            if(player.y < 0) player.y = canvas.height;
            if(player.y > canvas.height) player.y = 0;

            // Collisions
            GameState.microParticles.forEach((p, i) => {
                const pdx = p.x - player.x;
                const pdy = p.y - player.y;
                const pDist = Math.sqrt(pdx*pdx + pdy*pdy);
                if (pDist < p.size/2 + 5) {
                    if (p.type === 'U') {
                        GameState.microParticles.splice(i, 1);
                        GameState.reactivity += 0.001;
                        GameState.microFissions++;
                        AudioEngine.playSfx('fission');
                        if (GameState.microFissions >= 5) {
                            this.showMessage('ÉXITO', 'Reacción en cadena estabilizada.', 3000, () => this.switchLevel('MACRO'));
                        }
                    } else if (p.type === 'M') {
                        player.vx *= 0.8;
                        player.vy *= 0.8;
                    }
                }
            });
        },
        showMessage(title, text, duration = Infinity, callback = null) {
            const overlay = document.getElementById('message-overlay');
            document.getElementById('message-title').textContent = title;
            document.getElementById('message-text').textContent = text;
            overlay.style.display = 'block';
            if (duration !== Infinity) {
                setTimeout(() => {
                    overlay.style.display = 'none';
                    if (callback) callback();
                }, duration);
            }
        },
        endGame(reason) {
            GameState.gameStatus = reason;
            let title = 'FIN DEL JUEGO';
            let text = `Puntuación Final: ${Math.round(GameState.score)}`;
            if (reason === 'meltdown') title = '¡¡¡FUSIÓN DEL NÚCLEO!!!';
            if (reason === 'stall') title = 'REACCIÓN DETENIDA';
            this.showMessage(title, text);
        }
    };

    // --- BUCLE PRINCIPAL ---
    function gameLoop(timestamp) {
        if (GameState.gameStatus === 'idle' || GameState.gameStatus === 'paused') {
            requestAnimationFrame(gameLoop);
            return;
        }
        if (!GameState.lastUpdate) GameState.lastUpdate = timestamp;
        const dt = (timestamp - GameState.lastUpdate) / 1000;
        GameState.lastUpdate = timestamp;

        // Update
        PhysicsEngine.update(dt);
        if (GameState.currentLevel === 'MACRO') {
            GameState.player.x += GameState.player.vx * dt;
            GameState.player.x = Math.max(0, Math.min(canvas.width - GameState.player.width, GameState.player.x));
            GameState.player.vx = 0;
            if(InputHandler.keys['ArrowLeft']) GameState.player.vx = -150;
            if(InputHandler.keys['ArrowRight']) GameState.player.vx = 150;
        } else {
            GameManager.updateMicroLevel(dt);
        }
        
        // Render
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (GameState.currentLevel === 'MACRO') {
            Renderer.drawMacroLevel();
        } else {
            Renderer.drawMicroLevel();
        }
        Renderer.updateUI();
        AudioEngine.update();

        if (GameState.gameStatus === 'running' || GameState.gameStatus === 'scram') {
            requestAnimationFrame(gameLoop);
        }
    }

    // --- INICIALIZACIÓN ---
    AudioEngine.init();
    GameManager.init();

    </script>
</body>
</html>
