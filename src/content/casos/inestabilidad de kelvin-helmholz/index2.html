<!doctype html>
<html lang="es">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' ws://127.0.0.1:3002; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
  <meta charset="utf-8" />
  <title>K–H Instrumento • CSP estricto</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    #overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;color:#eee;z-index:20}
    #overlay .panel{max-width:720px;text-align:center;padding:24px}
    #overlay button{border:0;border-radius:12px;padding:14px 22px;font-size:16px;cursor:pointer;box-shadow:0 0 0 1px #444 inset;background:#111;color:#eee}
    #hud{position:fixed;left:10px;top:10px;color:#ddd;font-size:12px;line-height:1.25;user-select:none;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);padding:10px 12px;border-radius:12px;border:1px solid #333;max-width:min(92vw,420px);z-index:10}
    #hud h3{margin:0 0 8px 0;font-size:13px;color:#fff}
    .row{display:grid;grid-template-columns:110px 1fr 64px;align-items:center;gap:6px;margin:4px 0}
    .row label{color:#aaa}
    .row input[type=range]{width:100%}
    .row input[type=number]{width:64px;background:#0b0b0b;border:1px solid #333;color:#eee;border-radius:8px;padding:4px 6px}
    .buttons{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .buttons button{border:1px solid #333;background:#0b0b0b;color:#eee;border-radius:10px;padding:8px 10px;cursor:pointer}
    #readouts{margin-top:8px;color:#9aa;white-space:pre-wrap}
    #footer{position:fixed;left:10px;bottom:10px;color:#888;font-size:11px;background:rgba(0,0,0,.45);padding:6px 8px;border-radius:10px;border:1px solid #222}
  </style>
</head>
<body>
  <div id="overlay">
    <div class="panel">
      <h2 style="margin:0 0 10px 0;color:#fff">Kelvin–Helmholtz • instrumento web</h2>
      <p style="margin:0 0 12px 0;color:#bbb">Clic para iniciar AudioContext. Arrastra el mouse en X para variar la longitud de onda. Rueda para cambiar la cizalla.</p>
      <button id="start">Iniciar simulación + audio</button>
    </div>
  </div>

  <div id="hud">
    <h3>Parámetros en vivo</h3>
    <div class="row"><label for="particles">partículas</label><input id="particles" type="range" min="16" max="1024" step="16" value="256"><input id="particlesN" type="number" min="16" max="4096" step="16" value="256"></div>
    <div class="row"><label for="u0">U0</label><input id="u0" type="range" min="0.2" max="1.5" step="0.01" value="0.60"><input id="u0N" type="number" min="0.2" max="1.5" step="0.01" value="0.60"></div>
    <div class="row"><label for="delta">δ (rel)</label><input id="delta" type="range" min="0.10" max="0.42" step="0.01" value="0.22"><input id="deltaN" type="number" min="0.10" max="0.42" step="0.01" value="0.22"></div>
    <div class="row"><label for="k">k</label><input id="k" type="range" min="0.20" max="2.50" step="0.01" value="1.20"><input id="kN" type="number" min="0.20" max="2.50" step="0.01" value="1.20"></div>
    <div class="row"><label for="gain">ganancia dB</label><input id="gain" type="range" min="-30" max="0" step="1" value="-12"><input id="gainN" type="number" min="-30" max="0" step="1" value="-12"></div>
    <div class="row"><label for="shearMix">mix shear</label><input id="shearMix" type="range" min="0" max="1" step="0.01" value="0.55"><input id="shearMixN" type="number" min="0" max="1" step="0.01" value="0.55"></div>
    <div class="row"><label for="vyMix">mix |vy|</label><input id="vyMix" type="range" min="0" max="1" step="0.01" value="0.45"><input id="vyMixN" type="number" min="0" max="1" step="0.01" value="0.45"></div>
    <div class="row"><label for="fmin">f min</label><input id="fmin" type="range" min="20" max="2000" step="1" value="20"><input id="fminN" type="number" min="20" max="2000" step="1" value="20"></div>
    <div class="row"><label for="fmax">f max</label><input id="fmax" type="range" min="1000" max="12000" step="1" value="5000"><input id="fmaxN" type="number" min="1000" max="12000" step="1" value="5000"></div>
    <div class="buttons">
      <button id="applyParticles">Aplicar cambios de partículas</button>
      <button id="randomize">Randomizar seed</button>
      <button id="reset">Reset</button>
      <button id="fs">Fullscreen</button>
      <button id="mute">Mute</button>
      <button id="pause">Pausar</button>
      <button id="diag">Diagnóstico CSP</button>
    </div>
    <div id="readouts"></div>
  </div>

  <div id="footer">Mouse X = k; rueda = U0. Paleta KH: frío/cálido con brillo por cizalla.</div>

  <script>
    // Captura y muestra errores para no “autoresetear”
    window.onerror = (msg, src, lin, col, err) => {
      const r = document.getElementById('readouts');
      if(r) r.textContent = 'Error: ' + msg + (err && err.stack ? '\n' + err.stack : '');
      return false;
    };
  </script>

  <!-- Import ESM desde tu servidor (no CDN) -->
  <script type="module">
    import * as THREE from './vendor/three.module.min.js';

    // ——— Setup base (idéntico a la versión previa; no usa eval, ni workers) ———
    let WIDTH = innerWidth, HEIGHT = innerHeight;
    const WORLD_W = 12; let WORLD_H = WORLD_W * (HEIGHT/WIDTH);
    let params = {PARTICLES:256,U0:0.60,deltaRel:0.22,k:1.20,baseGainDB:-12,shearMix:0.55,vyMix:0.45,freqMin:20,freqMax:5000,seed:0xC0FFEE};
    let t=0, running=true;

    const scene = new THREE.Scene();
    const camera = new THREE.OrthographicCamera(-WORLD_W/2, WORLD_W/2, WORLD_H/2, -WORLD_H/2, 0.1, 100);
    camera.position.z = 5;
    const renderer = new THREE.WebGLRenderer({antialias:true});
    renderer.setSize(WIDTH, HEIGHT);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setClearColor(0x000000, 1);
    document.body.appendChild(renderer.domElement);

    let geom, points, mat, positions, velocities, colors;
    let audioCtx=null, master=null, limiter=null, muted=false, gains=[], oscs=[];
    const $ = s=>document.querySelector(s);

    const link = id => { const r=$('#'+id), n=$('#'+id+'N'); const fr=()=> (n.value=r.value,onParam(id,r)); const fn=()=> (r.value=n.value,onParam(id,r)); r.addEventListener('input',fr); n.addEventListener('change',fn);};
    ['particles','u0','delta','k','gain','shearMix','vyMix','fmin','fmax'].forEach(link);

    $('#applyParticles').addEventListener('click', ()=>{ const N=clamp(int($('#particlesN').value),16,4096); if(N!==params.PARTICLES){ params.PARTICLES=N; rebuild(true,true);} });
    $('#randomize').addEventListener('click', ()=>{ params.seed=(Math.random()*0xFFFFFFFF)>>>0; rebuild(true,false); });
    $('#reset').addEventListener('click', ()=>{ params={PARTICLES:256,U0:0.60,deltaRel:0.22,k:1.20,baseGainDB:-12,shearMix:0.55,vyMix:0.45,freqMin:20,freqMax:5000,seed:0xC0FFEE}; syncHUD(); rebuild(true,true); });
    $('#fs').addEventListener('click', ()=>{ if(!document.fullscreenElement) document.body.requestFullscreen().catch(()=>{}); else document.exitFullscreen().catch(()=>{}); });
    $('#mute').addEventListener('click', ()=>{ muted=!muted; if(master) master.gain.value = muted?0:dbToGain(params.baseGainDB); $('#mute').textContent = muted?'Unmute':'Mute'; });
    $('#pause').addEventListener('click', ()=>{ running=!running; $('#pause').textContent = running?'Pausar':'Reanudar'; });
    $('#diag').addEventListener('click', ()=>{
      const r=$('#readouts');
      const headerHint='Si tu servidor envía CSP por header, el meta no aplica. Editá Nginx/Apache/Vercel/Netlify.';
      try{
        // Intento seguro: nada de eval; solo ver si header pisa meta (no podemos leer header desde JS).
        r.textContent = 'Diagnóstico:\n- three cargado local (./vendor/three.module.min.js)\n- No workers, no DRACO, no eval\n- Si sigue el error, es el header CSP del server\n\n'+headerHint;
      }catch(e){ r.textContent='Diag falló: '+e.message; }
    });

    $('#start').addEventListener('click', async ()=>{ $('#overlay').style.display='none'; await startAudio(); });
    let pointerX=0.0; window.addEventListener('mousemove', e=>{ pointerX=(e.clientX/innerWidth-0.5)*2.0; }, {passive:true});
    window.addEventListener('wheel', e=>{ e.preventDefault(); params.U0=clamp(params.U0 + (-Math.sign(e.deltaY))*0.03,0.2,1.5); $('#u0').value=params.U0.toFixed(2); $('#u0N').value=params.U0.toFixed(2); }, {passive:false});
    window.addEventListener('resize', ()=>{ WIDTH=innerWidth; HEIGHT=innerHeight; WORLD_H=WORLD_W*(HEIGHT/WIDTH); camera.left=-WORLD_W/2; camera.right=WORLD_W/2; camera.top=WORLD_H/2; camera.bottom=-WORLD_H/2; camera.updateProjectionMatrix(); renderer.setSize(WIDTH,HEIGHT); }, {passive:true});

    syncHUD(); build(); animate();

    function rebuild(visual=true,audio=false){ if(visual){ dispose(); build(); } if(audio && audioCtx){ stopOscs(); buildOscs(params.PARTICLES); } }
    function build(){
      const N=params.PARTICLES;
      positions=new Float32Array(N*3); velocities=new Float32Array(N*2); colors=new Float32Array(N*3);
      const rng=mulberry32(params.seed>>>0);
      for(let i=0;i<N;i++){
        const y=(i/(N-1))*WORLD_H - WORLD_H/2; const x=(rng()-0.5)*WORLD_W;
        positions[3*i+0]=x; positions[3*i+1]=y; positions[3*i+2]=0;
        const U=params.U0*Math.tanh(y/(params.deltaRel*WORLD_H));
        velocities[2*i+0]=U+0.02*(rng()-0.5); velocities[2*i+1]=0.02*(rng()-0.5);
        const c=khColor(U,0); colors[3*i+0]=c.r; colors[3*i+1]=c.g; colors[3*i+2]=c.b;
      }
      geom=new THREE.BufferGeometry();
      geom.setAttribute('position', new THREE.BufferAttribute(positions,3));
      geom.setAttribute('color', new THREE.BufferAttribute(colors,3));
      mat=new THREE.PointsMaterial({size:6/renderer.getPixelRatio(),vertexColors:true,sizeAttenuation:false});
      points=new THREE.Points(geom,mat); scene.add(points);
    }
    function dispose(){ if(points){ scene.remove(points); points.geometry.dispose(); } if(geom){ geom.dispose(); } if(mat){ mat.dispose(); } }

    async function startAudio(){
      if(audioCtx) return;
      audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive', sampleRate:48000});
      master=audioCtx.createGain(); master.gain.value=dbToGain(params.baseGainDB);
      limiter=audioCtx.createDynamicsCompressor(); limiter.threshold.value=-10; limiter.knee.value=10; limiter.ratio.value=12; limiter.attack.value=0.003; limiter.release.value=0.12;
      master.connect(limiter).connect(audioCtx.destination);
      buildOscs(params.PARTICLES); if(muted) master.gain.value=0;
    }
    function buildOscs(N){ gains.length=0; oscs.length=0; for(let i=0;i<N;i++){ const o=audioCtx.createOscillator(); o.type='sine'; const g=audioCtx.createGain(); g.gain.value=0.0; o.connect(g).connect(master); o.start(); oscs.push(o); gains.push(g);} }
    function stopOscs(){ for(let i=0;i<oscs.length;i++){ try{oscs[i].stop();}catch{} try{oscs[i].disconnect();}catch{} try{gains[i].disconnect();}catch{} } oscs.length=0; gains.length=0; }

    function animate(){
      requestAnimationFrame(animate);
      if(!running){ renderer.render(scene,camera); return; }
      try{
        const dt=0.016; t+=dt;
        params.k=clamp(parseFloat($('#k').value)+pointerX*0.9,0.2,2.5); $('#k').value=params.k.toFixed(2); $('#kN').value=params.k.toFixed(2);
        const deltaAbs=params.deltaRel*WORLD_H;

        for(let i=0;i<params.PARTICLES;i++){
          const i3=3*i, i2=2*i; let x=positions[i3+0], y=positions[i3+1]; let vx=velocities[i2+0], vy=velocities[i2+1];
          const U=params.U0*Math.tanh(y/deltaAbs); const dUdy=(params.U0/deltaAbs)*sech2(y/deltaAbs);
          const phase=params.k*x - 1.2*t; const amp=0.18*WORLD_H*Math.exp(-Math.abs(y)/(0.55*WORLD_H)); const py=amp*0.3*Math.sin(phase);
          vx += (U-vx)*0.08; vy += (dUdy*0.05)*Math.cos(phase) + (py)*0.02;
          vx*=0.995; vy*=0.995; x+=vx*dt; y+=vy*dt;
          if (x<-WORLD_W/2) x+=WORLD_W; if (x>WORLD_W/2) x-=WORLD_W;
          if (y<-WORLD_H/2){ y=-WORLD_H/2; vy*=-0.4; } if (y>WORLD_H/2){ y= WORLD_H/2; vy*=-0.4; }
          positions[i3+0]=x; positions[i3+1]=y; velocities[i2+0]=vx; velocities[i2+1]=vy;
          const shear=Math.min(Math.abs(dUdy)*deltaAbs/params.U0,1.0); const col=khColor(U,shear);
          colors[i3+0]=col.r; colors[i3+1]=col.g; colors[i3+2]=col.b;
          if(audioCtx){ const y01=(y+WORLD_H/2)/WORLD_H; const f=lerp(params.freqMin,params.freqMax,y01);
            const energy=clamp(params.shearMix*shear + params.vyMix*Math.min(Math.abs(vy)/(params.U0*0.8),1.0),0,1);
            const g=Math.pow(energy,1.5)*0.02; oscs[i].frequency.setTargetAtTime(f,audioCtx.currentTime,0.01); gains[i].gain.setTargetAtTime(g,audioCtx.currentTime,0.05); }
        }
        geom.attributes.position.needsUpdate=true; geom.attributes.color.needsUpdate=true; renderer.render(scene,camera);
        $('#readouts').textContent=`N=${params.PARTICLES}  U0=${params.U0.toFixed(2)}  δ=${params.deltaRel.toFixed(2)}  k=${params.k.toFixed(2)}\n`+
                                   `gain=${params.baseGainDB} dB  f=[${params.freqMin},${params.freqMax}]  seed=0x${params.seed.toString(16)}`;
      }catch(e){ const r=$('#readouts'); if(r) r.textContent='Loop detenido: '+(e&&e.message?e.message:e); console.error(e); running=false; }
    }

    function syncHUD(){ $('#particles').value=params.PARTICLES; $('#particlesN').value=params.PARTICLES; $('#u0').value=params.U0; $('#u0N').value=params.U0; $('#delta').value=params.deltaRel; $('#deltaN').value=params.deltaRel; $('#k').value=params.k; $('#kN').value=params.k; $('#gain').value=params.baseGainDB; $('#gainN').value=params.baseGainDB; $('#shearMix').value=params.shearMix; $('#shearMixN').value=params.shearMix; $('#vyMix').value=params.vyMix; $('#vyMixN').value=params.vyMix; $('#fmin').value=params.freqMin; $('#fminN').value=params.freqMin; $('#fmax').value=params.freqMax; $('#fmaxN').value=params.freqMax; }
    function onParam(id,el){ const v=parseFloat(el.value);
      if(id==='particles'){ $('#particlesN').value=v; return; }
      if(id==='u0'){ params.U0=clamp(v,0.2,1.5); $('#u0N').value=params.U0.toFixed(2); return; }
      if(id==='delta'){ params.deltaRel=clamp(v,0.10,0.42); $('#deltaN').value=params.deltaRel.toFixed(2); return; }
      if(id==='k'){ params.k=clamp(v,0.2,2.5); $('#kN').value=params.k.toFixed(2); return; }
      if(id==='gain'){ params.baseGainDB=clamp(v,-30,0)|0; $('#gainN').value=params.baseGainDB; if(master&&!muted) master.gain.value=dbToGain(params.baseGainDB); return; }
      if(id==='shearMix'){ params.shearMix=clamp(v,0,1); $('#shearMixN').value=params.shearMix.toFixed(2); return; }
      if(id==='vyMix'){ params.vyMix=clamp(v,0,1); $('#vyMixN').value=params.vyMix.toFixed(2); return; }
      if(id==='fmin'){ params.freqMin=clamp(int(v),20,params.freqMax-10); $('#fminN').value=params.freqMin; return; }
      if(id==='fmax'){ params.freqMax=clamp(int(v),params.freqMin+10,12000); $('#fmaxN').value=params.freqMax; return; }
    }

    // Helpers
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function clamp(x,a,b){return Math.max(a,Math.min(b,x))}
    function lerp(a,b,t){return a + (b-a)*t}
    function sech2(z){const s = 1/Math.cosh(z); return s*s}
    function dbToGain(db){return Math.pow(10, db/20)}
    function int(x){return (x|0)}
    function khColor(U,shear){ const cold=new THREE.Color().setHSL(0.58,0.9,0.55); const warm=new THREE.Color().setHSL(0.08,0.95,0.55); const base=U>=0?warm.clone():cold.clone(); const hot=new THREE.Color().setHSL(0.13,1.0,0.70); base.lerp(hot,Math.min(0.75*shear,1.0)); return base; }
  </script>
</body>
</html>