<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mapa interactivo de energía músico-científica</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
    header { padding: 10px 14px; border-bottom: 1px solid #e5e7eb; display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; font-weight: 600; margin: 0 8px 0 0; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px 18px; align-items: center; }
    .legend { display: flex; gap: 12px; align-items: center; }
    .legend-item { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
    .swatch { width: 12px; height: 12px; border-radius: 2px; border: 1px solid #1114; }
    .axisLabel { font-size: 12px; fill: #374151; }
    .tick text { font-size: 12px; fill: #4b5563; }
    .tick line { stroke: #e5e7eb; }
    .grid line { stroke: #f1f5f9; }
    .node { cursor: grab; }
    .node:active { cursor: grabbing; }
    .node circle { stroke: #1116; stroke-width: 1; }
    .edge { stroke: #94a3b8; stroke-opacity: .5; }
    .edge.highlight { stroke-opacity: .85; stroke-width: 2; }
    .tooltip { position: absolute; pointer-events: none; background: #111; color: #fff; padding: 8px 10px; font-size: 12px; border-radius: 6px; box-shadow: 0 2px 10px #0005; opacity: 0; transition: opacity .12s; }
    .panel { display: flex; gap: 20px; align-items: center; }
    .sep { width: 1px; height: 22px; background: #e5e7eb; }
    .pill { font-size: 12px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 999px; background: #fff; cursor: pointer; }
    .pill.active { background: #111; color: #fff; border-color: #111; }
    .note { font-size: 12px; color: #6b7280; }
    .footer { position: absolute; bottom: 8px; right: 12px; font-size: 12px; color: #6b7280; background: #fff8; padding: 4px 8px; border-radius: 6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
</head>
<body>
<div id="app">
  <header>
    <h1>Mapa interactivo de energía músico-científica</h1>
    <div class="panel">
      <div class="controls" id="filters"></div>
      <div class="sep"></div>
      <button id="reset" class="pill">Reset vista</button>
      <button id="labels" class="pill active">Etiquetas: ON</button>
    </div>
    <span class="note">Ejes: vertical = escala energética · horizontal = fijo/monumental ⟷ portátil/nómada</span>
  </header>
  <div id="chart" style="position:relative; width:100%; height:100%;"></div>
</div>
<div class="tooltip" id="tt"></div>
<div class="footer">Arrastrá nodos · Shift+Wheel = zoom horizontal · Doble click: fijar/liberar</div>
<script>
(function(){
  // --- Configuración de ejes ---
  const energyLevels = [
    // de abajo (micro) a arriba (macro)
    "1 · Bioenergía (cuerpo)",
    "2 · Corporal extendida (instrumento)",
    "3 · Comunitaria/artesanal",
    "4 · Mecánica/hidráulica",
    "5 · Fósil/eléctrica",
    "6 · Nuclear (Atucha)",
    "7 · Renovable a gran escala",
    "8 · Planetaria (Kardashev I)",
    "9 · Estelar (Kardashev II)",
    "10 · Galáctica (Kardashev III)"
  ];

  // Tipo/familia energética para color
  const typeColors = {
    bio: "#22c55e",
    mecanica: "#f59e0b",
    fosil: "#ef4444",
    electrica: "#3b82f6",
    nuclear: "#8b5cf6",
    renovable: "#10b981",
    planetaria: "#0ea5e9",
    estelar: "#eab308",
    galactica: "#64748b",
    hibrida: "#ec4899"
  };

  // Datos de nodos (seed editable)
  const nodes = [
    // --- Bioenergía ---
    {id:"respiracion", label:"Respiración", level:0, xHint:-0.2, type:"bio", info:"Ritmo vital; energía de intercambio gaseoso"},
    {id:"corazon", label:"Latido/Corazón", level:0, xHint:-0.1, type:"bio", info:"Pulso fisiológico"},
    {id:"musculo", label:"Gesto muscular", level:0, xHint:0.1, type:"bio", info:"ATP→trabajo; control fino del gesto"},

    // Corporal extendida
    {id:"voz", label:"Voz", level:1, xHint:-0.1, type:"bio", info:"Columna de aire; resonadores"},
    {id:"arco", label:"Arco/cuerda", level:1, xHint:0.1, type:"mecanica", info:"Acoplamiento brazo–arco–cuerda"},

    // Comunitaria/artesanal
    {id:"coros", label:"Coro/Danza", level:2, xHint:-0.2, type:"bio", info:"Suma de cuerpos"},
    {id:"organohyd", label:"Órgano hidráulico", level:3, xHint:-0.6, type:"mecanica", info:"Energía fluida comunitaria"},

    // Mecánica/hidráulica
    {id:"molino", label:"Molino de agua/viento", level:3, xHint:-0.4, type:"mecanica", info:"Flujos naturales→trabajo"},

    // Fósil/eléctrica
    {id:"carbón", label:"Carbón/Vapor", level:4, xHint:-0.5, type:"fosil", info:"Solar fósil acumulada"},
    {id:"amplif", label:"Amplificación eléctrica", level:4, xHint:0.0, type:"electrica", info:"Micrófono/altavoz"},

    // Nuclear (Atucha)
    {id:"atucha", label:"Atucha I/II (PHWR)", level:5, xHint:-0.5, type:"nuclear", info:"Fisión uranio natural, agua pesada"},

    // Renovable
    {id:"solar", label:"Parque solar", level:6, xHint:-0.2, type:"renovable", info:"Fotovoltaico a gran escala"},
    {id:"eolica", label:"Eólica offshore", level:6, xHint:-0.1, type:"renovable", info:"Flujos atmosféricos"},

    // Planetaria
    {id:"grid", label:"Red planetaria inteligente", level:7, xHint:-0.2, type:"planetaria", info:"Kardashev I (parcial)"},

    // Estelar
    {id:"dyson", label:"Enjambre de Dyson", level:8, xHint:0.3, type:"estelar", info:"Colecta de radiación estelar"},

    // Galáctica
    {id:"galax", label:"Red galáctica de enjambres", level:9, xHint:0.4, type:"galactica", info:"Kardashev III"},

    // Cadena órgano→armonio→bandoneón→armónica
    {id:"orgIglesia", label:"Órgano de iglesia", level:3, xHint:-0.8, type:"mecanica", info:"Monumental, arquitectura sonora"},
    {id:"armonio", label:"Armonio", level:2, xHint:-0.5, type:"mecanica", info:"Reducción doméstica"},
    {id:"bandoneon", label:"Bandoneón", level:1, xHint:0.4, type:"hibrida", info:"Portátil, energía del fuelle humano"},
    {id:"armonica", label:"Armónica", level:0, xHint:0.6, type:"bio", info:"Respiración como motor"}
  ];

  // Enlaces (linajes / relaciones)
  const links = [
    {source:"orgIglesia", target:"armonio"},
    {source:"armonio", target:"bandoneon"},
    {source:"bandoneon", target:"armonica"},
    {source:"respiracion", target:"voz"},
    {source:"musculo", target:"arco"},
    {source:"molino", target:"organohyd"},
    {source:"carbón", target:"amplif"},
    {source:"atucha", target:"grid"},
    {source:"solar", target:"grid"},
    {source:"eolica", target:"grid"},
    {source:"grid", target:"dyson"},
    {source:"dyson", target:"galax"}
  ];

  // --- Lienzo ---
  const wrap = document.getElementById('chart');
  const tt = document.getElementById('tt');
  const W = () => wrap.clientWidth; const H = () => wrap.clientHeight;

  const svg = d3.select('#chart').append('svg')
    .attr('width', '100%')
    .attr('height', '100%')
    .attr('viewBox', `0 0 ${Math.max(900, window.innerWidth)} ${Math.max(600, window.innerHeight-60)}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const g = svg.append('g');

  // Escalas
  const y = d3.scalePoint()
    .domain(energyLevels)
    .range([H()-40, 40])
    .padding(0.8);

  const x = d3.scaleLinear()
    .domain([-1, 1]) // -1 fijo/monumental → 1 portátil/nómada
    .range([80, Math.max(900, window.innerWidth)-40]);

  // Ejes
  const yAxis = d3.axisLeft(y).tickSize(- (x.range()[1]-x.range()[0])).tickPadding(6);
  const xAxis = d3.axisBottom(x).ticks(7).tickFormat(v => v===-1?"Fijo/Monumental": v===1?"Portátil/Nómada": v.toFixed(1));

  const gy = g.append('g').attr('class','y axis grid').attr('transform',`translate(${x.range()[0]},0)`).call(yAxis);
  gy.selectAll('.domain').remove();

  const gx = g.append('g').attr('class','x axis').attr('transform',`translate(0,${H()-30})`).call(xAxis);
  gx.selectAll('.domain').attr('stroke','#e5e7eb');

  g.append('text').attr('class','axisLabel').attr('x', (x.range()[0]+x.range()[1])/2).attr('y', H()-6).attr('text-anchor','middle').text('Fijo/Monumental  ⟷  Portátil/Nómada');
  g.append('text').attr('class','axisLabel').attr('x', 16).attr('y', 20).text('Escala energética');

  // Definir y fijo por nivel
  nodes.forEach(n => n.yFixed = y(energyLevels[n.level]));
  // x sugerido
  nodes.forEach(n => n.xFixed = x(n.xHint));

  // Fuerzas
  const sim = d3.forceSimulation(nodes)
    .force('x', d3.forceX(d => d.xFixed).strength(0.2))
    .force('y', d3.forceY(d => d.yFixed).strength(0.3))
    .force('collide', d3.forceCollide(20))
    .force('link', d3.forceLink(links).id(d=>d.id).distance(80).strength(0.2))
    .alphaDecay(0.03);

  // Líneas
  const edge = g.append('g').attr('stroke-linecap','round')
    .selectAll('line').data(links).enter().append('line')
    .attr('class','edge')
    .attr('stroke-width',1.5);

  // Nodos
  const node = g.selectAll('.node').data(nodes).enter().append('g')
    .attr('class','node')
    .call(d3.drag()
      .on('start', dragstarted)
      .on('drag', dragged)
      .on('end', dragended)
    )
    .on('mouseenter', (e,d) => showTT(e,d))
    .on('mouseleave', hideTT)
    .on('dblclick', (_,d) => {
      d.fx = d.fx==null? d.x : null;
      d.fy = d.fy==null? d.y : null;
      sim.alpha(0.6).restart();
    })
    .on('click', (_,d) => highlightChain(d));

  node.append('circle')
    .attr('r', 9)
    .attr('fill', d => typeColors[d.type] || '#999');

  const labelsOn = {value: true};
  const label = node.append('text')
    .attr('dx', 12)
    .attr('dy', 4)
    .style('font-size','12px')
    .style('pointer-events','none')
    .text(d => d.label);

  function ticked(){
    edge
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);

    node.attr('transform', d => `translate(${d.x},${d.y})`);
  }
  sim.on('tick', ticked);

  // Tooltip
  function showTT(e,d){
    tt.innerHTML = `<b>${d.label}</b><br>${d.info || ''}<br><i>Nivel: ${energyLevels[d.level]}</i>`;
    tt.style.opacity = 1;
    const rect = wrap.getBoundingClientRect();
    tt.style.left = (e.clientX - rect.left + 12) + 'px';
    tt.style.top = (e.clientY - rect.top + 12) + 'px';
  }
  function hideTT(){ tt.style.opacity = 0; }

  // Filtros por tipo
  const uniqueTypes = Array.from(new Set(nodes.map(d=>d.type)));
  const filters = new Map(uniqueTypes.map(t => [t,true]));

  const filterWrap = document.getElementById('filters');
  uniqueTypes.forEach(t => {
    const item = document.createElement('label');
    item.className = 'legend-item';
    item.innerHTML = `<span class="swatch" style="background:${typeColors[t]||'#999'}"></span><input type="checkbox" checked data-type="${t}" /> ${t}`;
    filterWrap.appendChild(item);
  });

  filterWrap.addEventListener('change', (e)=>{
    const cb = e.target.closest('input[type="checkbox"]');
    if(!cb) return;
    filters.set(cb.dataset.type, cb.checked);
    applyFilters();
  });

  function applyFilters(){
    node.style('display', d => filters.get(d.type)? null : 'none');
    const visible = new Set(nodes.filter(d => filters.get(d.type)).map(d=>d.id));
    edge.style('display', d => (visible.has(d.source.id) && visible.has(d.target.id))? null : 'none');
  }

  // Highlight de cadena
  function highlightChain(d){
    const adj = new Map();
    links.forEach(l => {
      if(!adj.has(l.source.id)) adj.set(l.source.id, new Set());
      if(!adj.has(l.target.id)) adj.set(l.target.id, new Set());
      adj.get(l.source.id).add(l.target.id);
      adj.get(l.target.id).add(l.source.id);
    });
    const visited = new Set([d.id]);
    const q = [d.id];
    while(q.length){
      const u = q.shift();
      (adj.get(u)||[]).forEach(v => { if(!visited.has(v)){ visited.add(v); q.push(v);} });
    }
    edge.classed('highlight', l => visited.has(l.source.id) && visited.has(l.target.id));
    node.selectAll('circle').attr('stroke-width', nd => visited.has(nd.id)? 2.5 : 1);
  }

  // Controles
  document.getElementById('reset').addEventListener('click', ()=>{
    svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity);
    sim.alpha(0.8).restart();
  });
  document.getElementById('labels').addEventListener('click', (e)=>{
    labelsOn.value = !labelsOn.value;
    e.currentTarget.classList.toggle('active', labelsOn.value);
    label.style('display', labelsOn.value? null : 'none');
  });

  // Zoom/pan
  const zoom = d3.zoom()
    .scaleExtent([0.7, 2.5])
    .on('zoom', (event)=>{
      g.attr('transform', event.transform);
    });
  svg.call(zoom);

  // Drag helpers
  function dragstarted(event,d){
    if(!event.active) sim.alphaTarget(0.2).restart();
    d.fx = d.x; d.fy = d.y;
  }
  function dragged(event,d){ d.fx = event.x; d.fy = event.y; }
  function dragended(event,d){ if(!event.active) sim.alphaTarget(0); }

  // Redimensionar
  window.addEventListener('resize', ()=>{
    y.range([H()-40, 40]);
    nodes.forEach(n => n.yFixed = y(energyLevels[n.level]));
    gx.attr('transform',`translate(0,${H()-30})`).call(xAxis);
    gy.call(yAxis);
    sim.alpha(0.4).restart();
  });
})();
</script>
</body>
</html>
